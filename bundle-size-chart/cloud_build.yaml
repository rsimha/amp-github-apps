steps:
  # The first two steps are required to identify and inject un-redacted secrets.
- name: gcr.io/cloud-builders/npm
  args:
    - install
    - yaml
- name: gcr.io/cloud-builders/npm
  args:
    - run
    - replace-secrets
    - --
    - bundle-size-chart
  secretEnv: ['ACCESS_TOKEN']

  # Install app dependencies
- name: gcr.io/cloud-builders/npm
  dir: bundle-size-chart
  args:
    - install

  # Deploy the app and its cron tasks
- name: gcr.io/cloud-builders/gcloud
  dir: bundle-size-chart
  args:
    - --project
    - amp-bundle-size-chart-test
    - app
    - deploy
- name: gcr.io/cloud-builders/gcloud
  dir: bundle-size-chart
  args:
    - --project
    - amp-bundle-size-chart-test
    - app
    - deploy
    - cron.yaml

# These secrets are the base64-encoded form of encrypted secret values. They are
# automatically decrypted and added to the `.env` environment at build time.
secrets:
- kmsKeyName: projects/amp-bundle-size-chart-test/locations/global/keyRings/amp-github-apps-keyring/cryptoKeys/bundle-size-chart-env-key
  secretEnv:
    ACCESS_TOKEN: CiQA6qDuJ91Gu9MITgfX8zM550B+vNs6C5ojH810iTGwcWM9WpESUQB5Peyj8A/2maF7D7S65aP2Yp21IbQxVT3ouze/myjEUNSj52gSCq0xsvWaZcxXQKR+dbZw3IDsb7mWT9Asf889Mcx/MvOUyU2YbB3xP2UWtA==
